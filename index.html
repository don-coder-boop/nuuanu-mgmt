<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nuuanu - Influencer Seeding Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; overflow-x: hidden; }
        .aspect-lookbook { aspect-ratio: 2 / 3; }
        .aspect-product { aspect-ratio: 3 / 4; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .save-success { background-color: #10b981 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        // 에러 해결을 위한 아이콘 정의 방식 변경
        const { 
            X, Plus, ShoppingBag, ChevronDown, Check, Save, Trash2, 
            LogOut, Package, Truck, BarChart3, Settings, Upload
        } = lucideReact;

        // --- Utils ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1000;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        const StorageMonitor = () => {
            const [usage, setUsage] = useState(0);
            const limit = 5 * 1024 * 1024;
            useEffect(() => {
                const used = encodeURI(JSON.stringify(localStorage)).split(/%..|./).length - 1;
                setUsage(used);
            }, []);
            const percent = Math.min((usage / limit) * 100, 100);
            return (
                <div className="fixed bottom-4 right-4 bg-white border p-3 rounded-lg shadow-lg z-[100] w-48 space-y-2">
                    <div className="flex justify-between text-[9px] font-bold uppercase tracking-widest">
                        <span>Storage</span>
                        <span className={percent > 80 ? 'text-red-500' : 'text-gray-400'}>{Math.round(percent)}%</span>
                    </div>
                    <div className="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div className={`h-full transition-all ${percent > 80 ? 'bg-red-500' : 'bg-black'}`} style={{ width: `${percent}%` }}></div>
                    </div>
                </div>
            );
        };

        const InputField = ({ label, value, onChange, type = "text" }) => (
            <div className="space-y-1.5 w-full">
                <label className="text-[10px] uppercase tracking-widest text-gray-400 font-bold">{label}</label>
                <input type={type} value={value} onChange={e => onChange(e.target.value)} className="w-full border-b border-gray-200 py-2 focus:outline-none focus:border-black transition-colors bg-transparent text-sm uppercase" />
            </div>
        );

        // --- Admin Components ---
        const SettingsTab = ({ collection, onUpdate, showMsg }) => {
            const [lc, setLc] = useState({...collection});
            const [saving, setSaving] = useState(false);
            const handleSave = async () => { setSaving(true); await onUpdate(lc); setSaving(false); showMsg("Saved"); };

            return (
                <div className="space-y-12 animate-fade-in">
                    <div className="grid grid-cols-2 gap-12">
                        <InputField label="Collection Name" value={lc.name} onChange={v => setLc({...lc, name:v})} />
                        <InputField label="Welcome Title" value={lc.descriptionTitle} onChange={v => setLc({...lc, descriptionTitle:v})} />
                    </div>
                    <div className="space-y-6">
                        <h3 className="text-xs font-bold uppercase tracking-widest">Lookbook (Drag & Drop)</h3>
                        <div onDragOver={e=>e.preventDefault()} onDrop={async e=>{e.preventDefault(); const urls=await Promise.all(Array.from(e.dataTransfer.files).map(compressImage)); setLc({...lc, lookbook:[...lc.lookbook, ...urls.map(u=>({id:Math.random(),url:u}))]});}} className="flex flex-wrap gap-2 min-h-[100px] border border-dashed p-4 border-gray-200">
                            {lc.lookbook.map(lb=>(<div key={lb.id} className="relative w-20 aspect-lookbook group"><img src={lb.url} className="w-full h-full object-cover"/><button onClick={()=>setLc({...lc, lookbook:lc.lookbook.filter(i=>i.id!==lb.id)})} className="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center"><X size={14}/></button></div>))}
                        </div>
                    </div>
                    <button onClick={handleSave} className={`w-full py-4 text-xs tracking-widest uppercase transition-all ${saving ? 'save-success text-white' : 'bg-black text-white'}`}>{saving ? 'SAVED' : 'SAVE CHANGES'}</button>
                </div>
            );
        };

        const ProductsTab = ({ collection, onUpdate, showMsg }) => {
            const [prods, setProds] = useState([...collection.products]);
            const [saving, setSaving] = useState(false);
            const handleSave = async () => { setSaving(true); await onUpdate({...collection, products:prods}); setSaving(false); showMsg("Saved"); };

            return (
                <div className="space-y-8 animate-fade-in">
                    <button onClick={()=>setProds([...prods, {id:Math.random().toString(36).substr(2,9), name:'New Item', options:['S','M','L'], summary:'', images:[]}])} className="text-[10px] border border-black px-4 py-2 uppercase font-bold">+ Add Product</button>
                    {prods.map((p, i)=>(
                        <div key={p.id} className="p-6 bg-gray-50 border border-gray-100 flex gap-6 relative">
                            <div className="flex-1"><InputField label="Product Name" value={p.name} onChange={v=>{const n=[...prods]; n[i].name=v; setProds(n);}} /></div>
                            <div onDragOver={e=>e.preventDefault()} onDrop={async e=>{e.preventDefault(); const urls=await Promise.all(Array.from(e.dataTransfer.files).map(compressImage)); const n=[...prods]; n[i].images=[...n[i].images, ...urls]; setProds(n);}} className="w-40 h-20 border border-dashed border-gray-300 flex items-center justify-center text-[10px] text-gray-400">DROP IMAGE</div>
                            <button onClick={()=>setProds(prods.filter(it=>it.id!==p.id))} className="text-gray-300 hover:text-red-500"><X size={16}/></button>
                        </div>
                    ))}
                    <button onClick={handleSave} className={`w-full py-4 text-xs tracking-widest uppercase transition-all ${saving ? 'save-success text-white' : 'bg-black text-white'}`}>{saving ? 'SAVED' : 'SAVE CATALOG'}</button>
                </div>
            );
        };

        const ShippingTab = ({ collection, onUpdate }) => {
            const [orders, setOrders] = useState([...collection.orders]);
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-end"><button onClick={()=>onUpdate({...collection, orders})} className="bg-black text-white px-6 py-2 text-[10px] uppercase font-bold">Save Orders</button></div>
                    <div className="border rounded overflow-hidden"><table className="w-full text-left text-[10px] uppercase"><thead className="bg-gray-50 border-b"><tr><th className="p-4">Status</th><th className="p-4">Name</th><th className="p-4">Product</th><th className="p-4">Action</th></tr></thead><tbody>{orders.map(o=>(<tr key={o.id} className="border-b"><td className="p-4 font-bold">{o.status}</td><td className="p-4">{o.name}</td><td className="p-4">{o.productName} ({o.size})</td><td className="p-4"><button onClick={()=>setOrders(orders.filter(it=>it.id!==o.id))}><Trash2 size={14}/></button></td></tr>))}</tbody></table></div>
                </div>
            );
        };

        const AdminDashboard = ({ collections, onUpdateCollection, onAddCollection, onDeleteCollection, onLogout }) => {
            const [activeColId, setActiveColId] = useState(null);
            const [tab, setTab] = useState('Settings');
            const [msg, setMsg] = useState(null);
            const activeCol = useMemo(() => collections.find(c => c.id === activeColId), [collections, activeColId]);

            if (!activeColId) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-gray-50">
                    <div className="w-full max-w-md bg-white p-10 shadow-xl space-y-8">
                        <div className="flex justify-between border-b pb-4"><h1 className="font-bold italic uppercase tracking-widest">Admin</h1><button onClick={onLogout}><LogOut size={16}/></button></div>
                        {collections.map(c=>(<button key={c.id} onClick={()=>setActiveColId(c.id)} className="w-full p-6 border hover:border-black flex justify-between uppercase text-xs"><span>{c.name}</span><b>{c.orders.length}</b></button>))}
                        <button onClick={()=>onAddCollection({id:Math.random(), name:prompt('Name?'), accessCodes:[], lookbook:[], products:[], orders:[], descriptionTitle:'', descriptionBody:''})} className="w-full border-dashed border p-4 text-gray-400 text-xs">+ New Collection</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-white flex">
                    <aside className="w-64 border-r p-6 space-y-8 fixed inset-y-0">
                        <h2 className="font-bold italic uppercase tracking-tighter">nuuanu admin</h2>
                        <nav className="space-y-2">
                            {['Settings', 'Products', 'Shipping'].map(t=>(<button key={t} onClick={()=>setTab(t)} className={`w-full text-left p-4 text-[10px] font-bold uppercase tracking-widest transition-all ${tab===t ? 'bg-black text-white' : 'text-gray-400 hover:bg-gray-50'}`}>{t}</button>))}
                        </nav>
                        <button onClick={()=>setActiveColId(null)} className="absolute bottom-6 left-6 text-[10px] uppercase text-gray-400">← Back</button>
                    </aside>
                    <main className="flex-1 ml-64 p-12 max-w-5xl">
                        <div className="flex justify-between border-b pb-6 mb-8">
                            <h2 className="text-2xl font-light uppercase tracking-widest">{activeCol.name} / {tab}</h2>
                            {msg && <span className="bg-black text-white px-4 py-1 text-[10px] animate-fade-in">{msg}</span>}
                        </div>
                        {tab==='Settings' && <SettingsTab collection={activeCol} onUpdate={onUpdateCollection} showMsg={setMsg}/>}
                        {tab==='Products' && <ProductsTab collection={activeCol} onUpdate={onUpdateCollection} showMsg={setMsg}/>}
                        {tab==='Shipping' && <ShippingTab collection={activeCol} onUpdate={onUpdateCollection}/>}
                        <StorageMonitor />
                    </main>
                </div>
            );
        };

        const InfluencerPage = ({ collection, limit, onLogout, onOrderSubmit }) => {
            const [view, setView] = useState('shop');
            const [cart, setCart] = useState([]);
            const [formData, setFormData] = useState({ instagramId: '', name: '', phone: '', address: '', agreed: false });

            useEffect(() => {
                if (view === 'shop') {
                    const pos = sessionStorage.getItem('nuuanu_scroll');
                    if (pos) window.scrollTo(0, parseInt(pos));
                }
                const saveScroll = () => { if(view === 'shop') sessionStorage.setItem('nuuanu_scroll', window.scrollY); };
                window.addEventListener('scroll', saveScroll);
                return () => window.removeEventListener('scroll', saveScroll);
            }, [view]);

            return (
                <div className="min-h-screen bg-white">
                    <header className="p-6 border-b flex justify-between items-center sticky top-0 bg-white/80 backdrop-blur-md z-50">
                        <h1 className="font-bold italic uppercase tracking-widest">nuuanu</h1>
                        <div className="flex gap-6 items-center">
                            <button onClick={()=>setView('cart')} className="text-xs font-bold uppercase tracking-widest">Cart ({cart.length}/{limit})</button>
                            <button onClick={onLogout}><LogOut size={16}/></button>
                        </div>
                    </header>
                    {view === 'shop' ? (
                        <main className="max-w-6xl mx-auto p-6 space-y-20 animate-fade-in">
                            <section className="text-center space-y-4 pt-10">
                                <h2 className="text-xl font-light uppercase tracking-[0.3em]">{collection.descriptionTitle}</h2>
                                <p className="text-[10px] text-gray-500 max-w-md mx-auto">{collection.descriptionBody}</p>
                            </section>
                            <section className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {collection.lookbook.map(img=>(<div key={img.id} className="aspect-lookbook"><img src={img.url} className="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-700"/></div>))}
                            </section>
                            <section className="grid grid-cols-1 md:grid-cols-3 gap-12">
                                {collection.products.map(p=>(
                                    <div key={p.id} className="space-y-4">
                                        <div className="aspect-product bg-gray-50">{p.images[0] && <img src={p.images[0]} className="w-full h-full object-cover"/>}</div>
                                        <div className="flex justify-between items-end"><h3 className="text-xs font-bold uppercase tracking-tighter">{p.name}</h3></div>
                                        <div className="flex gap-2">{p.options.map(s=>(<button key={s} onClick={()=>cart.length < limit ? setCart([...cart, {product:p, size:s}]) : alert('Limit reached')} className="flex-1 border border-gray-100 py-2 text-[10px] uppercase hover:border-black">Select {s}</button>))}</div>
                                    </div>
                                ))}
                            </section>
                        </main>
                    ) : (
                        <div className="max-w-xl mx-auto p-6 pt-20 space-y-12 animate-fade-in">
                            <h2 className="text-center font-bold uppercase tracking-widest border-b pb-4">Checkout</h2>
                            <div className="space-y-4">
                                {cart.map((item, idx)=>(<div key={idx} className="flex justify-between items-center border-b pb-4 text-xs"><span>{item.product.name} ({item.size})</span><button onClick={()=>setCart(cart.filter((_,i)=>i!==idx))}><X size={14}/></button></div>))}
                            </div>
                            <div className="space-y-6">
                                <InputField label="Instagram ID" value={formData.instagramId} onChange={v=>setFormData({...formData, instagramId:v})} />
                                <InputField label="Name" value={formData.name} onChange={v=>setFormData({...formData, name:v})} />
                                <InputField label="Phone" value={formData.phone} onChange={v=>setFormData({...formData, phone:v})} />
                                <InputField label="Address" value={formData.address} onChange={v=>setFormData({...formData, address:v})} />
                                <button onClick={()=>{onOrderSubmit(cart.map(c=>({id:Math.random(), status:'Preparing', date:new Date().toLocaleDateString(), ...formData, productName:c.product.name, size:c.size}))); setView('success');}} className="w-full bg-black text-white py-4 text-xs font-bold uppercase tracking-widest">Submit</button>
                            </div>
                        </div>
                    )}
                    {view === 'success' && <div className="fixed inset-0 bg-white flex items-center justify-center text-center p-6"><div className="space-y-6"><h2 className="text-2xl uppercase tracking-widest italic">Order Submitted!</h2><button onClick={onLogout} className="border border-black px-10 py-3 text-[10px] uppercase font-bold">Close</button></div></div>}
                </div>
            );
        };

        const App = () => {
            const [collections, setCollections] = useState(() => JSON.parse(localStorage.getItem('nuuanu_v7')) || [{id:'init', name:'25FW', accessCodes:[{code:'NUUANU25', limit:3}], lookbook:[], products:[], orders:[], descriptionTitle:'WELCOME', descriptionBody:''}]);
            const [session, setSession] = useState(null);
            const [code, setCode] = useState('');

            useEffect(() => { localStorage.setItem('nuuanu_v7', JSON.stringify(collections)); }, [collections]);

            const login = () => {
                if(code === 'ADMIN') setSession({role:'admin'});
                else {
                    const col = collections.find(c => c.accessCodes.some(ac => ac.code === code));
                    if(col) setSession({role:'influencer', id:col.id, limit: col.accessCodes.find(ac=>ac.code===code).limit});
                    else alert('Invalid Code');
                }
            };

            if(!session) return (
                <div className="min-h-screen flex items-center justify-center bg-white p-6">
                    <div className="w-full max-w-sm text-center space-y-10 animate-fade-in">
                        <h1 className="text-3xl italic font-light uppercase tracking-widest">nuuanu</h1>
                        <div className="space-y-4">
                            <input type="text" placeholder="ENTER CODE" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} className="w-full border-b py-3 text-center focus:outline-none tracking-widest text-sm" />
                            <button onClick={login} className="w-full bg-black text-white py-4 text-[10px] font-bold uppercase tracking-widest">Enter</button>
                        </div>
                    </div>
                </div>
            );

            if(session.role === 'admin') return <AdminDashboard collections={collections} onUpdateCollection={upd => setCollections(collections.map(c => c.id === upd.id ? upd : c))} onAddCollection={newC => setCollections([...collections, newC])} onDeleteCollection={id => setCollections(collections.filter(c => c.id !== id))} onLogout={()=>setSession(null)} />;
            const activeCol = collections.find(c => c.id === session.id);
            return <InfluencerPage collection={activeCol} limit={session.limit} onLogout={()=>setSession(null)} onOrderSubmit={newO => setCollections(collections.map(c => c.id === activeCol.id ? {...activeCol, orders:[...activeCol.orders, ...newO]} : c))} />;
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
