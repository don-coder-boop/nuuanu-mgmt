<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nuuanu - Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; }
        .aspect-lookbook { aspect-ratio: 2 / 3; }
        .aspect-product { aspect-ratio: 3 / 4; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- 아이콘을 SVG 문자열로 직접 정의 (에러 원천 차단) ---
        const Icon = ({ name }) => {
            const icons = {
                X: <svg size="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>,
                Plus: <svg size="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>,
                Save: <svg size="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2zM17 21v-8H7v8M7 3v5h8"/></svg>,
                Trash: <svg size="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>,
                LogOut: <svg size="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
            };
            return <span className="inline-block w-[18px] h-[18px]">{icons[name] || null}</span>;
        };

        // --- 이미지 압축 ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                };
            });
        };

        // --- 저장 용량 모니터 ---
        const StorageMonitor = () => {
            const [usage, setUsage] = useState(0);
            const limit = 5 * 1024 * 1024;
            useEffect(() => {
                const check = () => setUsage(encodeURI(JSON.stringify(localStorage)).length);
                check();
                window.addEventListener('storage', check);
                return () => window.removeEventListener('storage', check);
            }, []);
            const percent = Math.min((usage / limit) * 100, 100);
            return (
                <div className="fixed bottom-4 right-4 bg-white border p-3 rounded shadow-lg z-50 w-40">
                    <div className="flex justify-between text-[8px] font-bold uppercase mb-1">
                        <span>Storage</span>
                        <span className={percent > 80 ? 'text-red-500' : ''}>{Math.round(percent)}%</span>
                    </div>
                    <div className="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
                        <div className={`h-full ${percent > 80 ? 'bg-red-500' : 'bg-black'}`} style={{ width: `${percent}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- UI Components ---
        const InputField = ({ label, value, onChange, type = "text" }) => (
            <div className="space-y-1 w-full text-left">
                <label className="text-[9px] uppercase tracking-widest text-gray-400 font-bold">{label}</label>
                <input type={type} value={value} onChange={e => onChange(e.target.value)} className="w-full border-b border-gray-200 py-1 focus:outline-none focus:border-black transition-colors bg-transparent text-sm" />
            </div>
        );

        // --- Admin ---
        const AdminDashboard = ({ collections, onUpdateCollection, onLogout }) => {
            const [activeColId, setActiveColId] = useState(null);
            const [tab, setTab] = useState('Settings');
            const activeCol = collections.find(c => c.id === activeColId);

            if (!activeColId) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
                    <div className="w-full max-w-sm bg-white p-8 shadow-sm space-y-6">
                        <div className="flex justify-between items-center border-b pb-4">
                            <h1 className="font-bold uppercase tracking-tighter">nuuanu Admin</h1>
                            <button onClick={onLogout}><Icon name="LogOut"/></button>
                        </div>
                        {collections.map(c => (
                            <button key={c.id} onClick={() => setActiveColId(c.id)} className="w-full p-4 border text-left flex justify-between hover:bg-gray-50 uppercase text-xs">
                                {c.name} <span>→</span>
                            </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-white flex">
                    <aside className="w-56 border-r p-6 space-y-4">
                        <h2 className="font-black uppercase text-sm mb-10 tracking-tighter">nuuanu</h2>
                        <button onClick={() => setTab('Settings')} className={`w-full text-left p-3 text-[10px] font-bold uppercase ${tab==='Settings'?'bg-black text-white':'text-gray-400'}`}>Setup</button>
                        <button onClick={() => setTab('Orders')} className={`w-full text-left p-3 text-[10px] font-bold uppercase ${tab==='Orders'?'bg-black text-white':'text-gray-400'}`}>Orders</button>
                        <button onClick={() => setActiveColId(null)} className="pt-10 text-[9px] text-gray-300 uppercase italic">← Back</button>
                    </aside>
                    <main className="flex-1 p-12">
                        <h2 className="text-xl font-light uppercase tracking-widest mb-10 border-b pb-4">{activeCol.name} / {tab}</h2>
                        {tab === 'Settings' ? (
                            <div className="max-w-xl space-y-10 animate-fade-in">
                                <InputField label="Title" value={activeCol.descriptionTitle} onChange={v => onUpdateCollection({...activeCol, descriptionTitle: v})} />
                                <div className="space-y-4">
                                    <h3 className="text-[10px] font-bold uppercase text-gray-400">Lookbook Images (Drop)</h3>
                                    <div onDragOver={e=>e.preventDefault()} onDrop={async e=>{
                                        e.preventDefault();
                                        const urls = await Promise.all(Array.from(e.dataTransfer.files).map(compressImage));
                                        onUpdateCollection({...activeCol, lookbook: [...activeCol.lookbook, ...urls.map(u=>({id:Date.now()+Math.random(), url:u}))]});
                                    }} className="grid grid-cols-4 gap-2 border-2 border-dashed p-4 min-h-[100px]">
                                        {activeCol.lookbook.map(img => (
                                            <div key={img.id} className="relative aspect-lookbook bg-gray-100">
                                                <img src={img.url} className="w-full h-full object-cover" />
                                                <button onClick={() => onUpdateCollection({...activeCol, lookbook: activeCol.lookbook.filter(i=>i.id!==img.id)})} className="absolute top-1 right-1 bg-white p-0.5"><Icon name="X"/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <button onClick={() => alert('Saved to LocalStorage')} className="w-full bg-black text-white py-4 text-xs font-bold uppercase">Save All Changes</button>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                <table className="w-full text-[10px] text-left uppercase">
                                    <thead className="border-b"><tr><th className="py-2">Date</th><th className="py-2">Instagram</th><th className="py-2">Product</th></tr></thead>
                                    <tbody>{activeCol.orders.map(o=>(<tr key={o.id} className="border-b"><td className="py-3">{o.date}</td><td className="py-3 font-bold">{o.instagramId}</td><td className="py-3">{o.productName} ({o.size})</td></tr>))}</tbody>
                                </table>
                            </div>
                        )}
                        <StorageMonitor />
                    </main>
                </div>
            );
        };

        // --- Influencer ---
        const InfluencerPage = ({ collection, limit, onLogout, onOrderSubmit }) => {
            const [cart, setCart] = useState([]);
            const [formData, setFormData] = useState({ instagramId: '', name: '', phone: '', address: '' });
            const [step, setStep] = useState('shop');

            if (step === 'success') return (
                <div className="min-h-screen flex items-center justify-center uppercase tracking-widest text-center px-10">
                    <div className="space-y-6"><h2>Order Success</h2><button onClick={onLogout} className="border border-black px-10 py-2 text-xs">Exit</button></div>
                </div>
            );

            return (
                <div className="min-h-screen bg-white">
                    <header className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-50">
                        <h1 className="font-bold italic uppercase tracking-widest">nuuanu</h1>
                        <button onClick={() => setStep(step === 'shop' ? 'cart' : 'shop')} className="text-[10px] font-bold uppercase">
                            {step === 'shop' ? `Selection (${cart.length}/${limit})` : 'Back to Shop'}
                        </button>
                    </header>
                    {step === 'shop' ? (
                        <main className="max-w-4xl mx-auto p-6 py-20 space-y-20 animate-fade-in">
                            <div className="text-center space-y-4">
                                <h2 className="text-xl font-light tracking-widest uppercase">{collection.descriptionTitle}</h2>
                                <p className="text-[10px] text-gray-400 max-w-xs mx-auto">{collection.descriptionBody}</p>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                {collection.lookbook.map(img => <div key={img.id} className="aspect-lookbook bg-gray-50"><img src={img.url} className="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-1000" /></div>)}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                                {collection.products.map(p => (
                                    <div key={p.id} className="space-y-4">
                                        <div className="aspect-product bg-gray-100">{p.images?.[0] && <img src={p.images[0]} className="w-full h-full object-cover" />}</div>
                                        <div className="flex justify-between items-center"><h3 className="text-[10px] font-bold uppercase">{p.name}</h3></div>
                                        <div className="flex gap-1">{['S', 'M', 'L'].map(s => <button key={s} onClick={() => cart.length < limit ? setCart([...cart, {p, s}]) : alert('Limit reached')} className="flex-1 border text-[9px] py-2 hover:bg-black hover:text-white transition-all uppercase">Select {s}</button>)}</div>
                                    </div>
                                ))}
                            </div>
                        </main>
                    ) : (
                        <div className="max-w-sm mx-auto p-6 pt-20 space-y-10 animate-fade-in">
                            <h2 className="font-bold uppercase text-xs border-b pb-2">Your Cart</h2>
                            {cart.map((item, idx) => <div key={idx} className="flex justify-between text-[10px] uppercase"><span>{item.p.name} ({item.s})</span><button onClick={()=>setCart(cart.filter((_,i)=>i!==idx))}>[Remove]</button></div>)}
                            <div className="space-y-4 pt-10">
                                <InputField label="Instagram ID" value={formData.instagramId} onChange={v=>setFormData({...formData, instagramId:v})} />
                                <InputField label="Name" value={formData.name} onChange={v=>setFormData({...formData, name:v})} />
                                <InputField label="Address" value={formData.address} onChange={v=>setFormData({...formData, address:v})} />
                                <button onClick={()=>{
                                    onOrderSubmit(cart.map(i=>({id:Date.now()+Math.random(), date:new Date().toLocaleDateString(), ...formData, productName:i.p.name, size:i.s})));
                                    setStep('success');
                                }} className="w-full bg-black text-white py-4 text-xs font-bold uppercase">Submit Order</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Root App ---
        const App = () => {
            const [collections, setCollections] = useState(() => {
                return JSON.parse(localStorage.getItem('nuuanu_v8')) || [
                    { id: '25fw', name: '25FW', accessCodes:[{code:'CODE', limit:3}], lookbook: [], products: [{id:1, name:'Sample Outer', images:[]}], orders: [], descriptionTitle: 'COLLECTION 25FW', descriptionBody: 'Select your pieces.' }
                ];
            });
            const [session, setSession] = useState(null);
            const [inputCode, setInputCode] = useState('');

            useEffect(() => { localStorage.setItem('nuuanu_v8', JSON.stringify(collections)); }, [collections]);

            const handleLogin = () => {
                if (inputCode === 'ADMIN') setSession({ role: 'admin' });
                else {
                    const col = collections.find(c => c.accessCodes.some(ac => ac.code === inputCode));
                    if (col) setSession({ role: 'influencer', id: col.id, limit: col.accessCodes.find(ac=>ac.code===inputCode).limit });
                    else alert('Invalid Code');
                }
            };

            if (!session) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-white">
                    <div className="w-full max-w-xs text-center space-y-8 animate-fade-in">
                        <h1 className="text-2xl italic font-light tracking-[0.3em] uppercase">nuuanu</h1>
                        <div className="space-y-4">
                            <input type="text" placeholder="ENTER ACCESS CODE" value={inputCode} onChange={e=>setInputCode(e.target.value.toUpperCase())} className="w-full border-b py-2 text-center focus:outline-none text-xs tracking-widest" />
                            <button onClick={handleLogin} className="w-full bg-black text-white py-3 text-[10px] font-bold uppercase tracking-widest">Enter</button>
                        </div>
                    </div>
                </div>
            );

            if (session.role === 'admin') return <AdminDashboard collections={collections} onUpdateCollection={upd => setCollections(collections.map(c => c.id === upd.id ? upd : c))} onLogout={() => setSession(null)} />;
            
            const activeCol = collections.find(c => c.id === session.id);
            return <InfluencerPage collection={activeCol} limit={session.limit} onLogout={() => setSession(null)} onOrderSubmit={newO => setCollections(collections.map(c => c.id === activeCol.id ? {...activeCol, orders: [...activeCol.orders, ...newO]} : c))} />;
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
